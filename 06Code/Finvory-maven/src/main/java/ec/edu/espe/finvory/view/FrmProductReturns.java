package ec.edu.espe.finvory.view;

import ec.edu.espe.finvory.controller.FinvoryController;
import javax.swing.JDialog;
import ec.edu.espe.finvory.model.ReturnedProduct;
import javax.swing.JOptionPane;

/**
 *
 * @author Mathews Pastor, The POOwer Rangers Of Programming
 */
public class FrmProductReturns extends JDialog {

    FinvoryController controller;
    ReturnedProduct product = new ReturnedProduct();


    public FrmProductReturns(java.awt.Dialog parent, boolean modal, FinvoryController controller) {
        super(parent, modal);
        this.controller = controller;
        initComponents();
        ButtonStyles.applyPrimaryStyle(btnReturn);
        ButtonStyles.applyPrimaryStyle(btnConfirm);
        lblDateValue.setText(java.time.LocalDate.now().toString());
        this.setLocationRelativeTo(parent);

    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        lblTitle = new javax.swing.JLabel();
        lblProductID = new javax.swing.JLabel();
        txtId = new javax.swing.JTextField();
        lblQuantity = new javax.swing.JLabel();
        txtQuantity = new javax.swing.JTextField();
        lblReason = new javax.swing.JLabel();
        cmbReason = new javax.swing.JComboBox<>();
        btnReturn = new javax.swing.JButton();
        btnConfirm = new javax.swing.JButton();
        lblDateValue = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        jPanel1.setBackground(new java.awt.Color(224, 224, 224));

        lblTitle.setFont(new java.awt.Font("Perpetua Titling MT", 1, 20)); // NOI18N
        lblTitle.setText("DEVOLUCIONES");

        lblProductID.setFont(new java.awt.Font("Copperplate Gothic Light", 0, 14)); // NOI18N
        lblProductID.setText("ID del producto:");

        txtId.setFont(new java.awt.Font("Copperplate Gothic Light", 0, 14)); // NOI18N

        lblQuantity.setFont(new java.awt.Font("Copperplate Gothic Light", 0, 14)); // NOI18N
        lblQuantity.setText("Cantidad:");

        txtQuantity.setFont(new java.awt.Font("Copperplate Gothic Light", 0, 14)); // NOI18N
        txtQuantity.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtQuantityActionPerformed(evt);
            }
        });

        lblReason.setFont(new java.awt.Font("Copperplate Gothic Light", 0, 14)); // NOI18N
        lblReason.setText("Motivo de la devolución:");

        cmbReason.setFont(new java.awt.Font("Copperplate Gothic Light", 0, 14)); // NOI18N
        cmbReason.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "Defectuoso", "Compra Incorrecta", "Otro" }));

        btnReturn.setBackground(new java.awt.Color(0, 123, 0));
        btnReturn.setFont(new java.awt.Font("Copperplate Gothic Light", 0, 14)); // NOI18N
        btnReturn.setForeground(new java.awt.Color(242, 242, 242));
        btnReturn.setText("VOLVER");
        btnReturn.setBorder(new javax.swing.border.SoftBevelBorder(javax.swing.border.BevelBorder.RAISED));
        btnReturn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnReturnActionPerformed(evt);
            }
        });

        btnConfirm.setBackground(new java.awt.Color(0, 123, 0));
        btnConfirm.setFont(new java.awt.Font("Copperplate Gothic Light", 0, 14)); // NOI18N
        btnConfirm.setForeground(new java.awt.Color(242, 242, 242));
        btnConfirm.setText("CONFIRMAR");
        btnConfirm.setBorder(new javax.swing.border.SoftBevelBorder(javax.swing.border.BevelBorder.RAISED));
        btnConfirm.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnConfirmActionPerformed(evt);
            }
        });

        lblDateValue.setFont(new java.awt.Font("Copperplate Gothic Light", 0, 14)); // NOI18N
        lblDateValue.setText("00/00/0000");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                .addGap(0, 0, Short.MAX_VALUE)
                .addComponent(lblTitle)
                .addGap(123, 123, 123))
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(lblProductID)
                            .addComponent(lblQuantity))
                        .addGap(18, 18, 18)
                        .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(txtId, javax.swing.GroupLayout.DEFAULT_SIZE, 195, Short.MAX_VALUE)
                            .addComponent(txtQuantity)))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGap(57, 57, 57)
                        .addComponent(btnReturn)
                        .addGap(83, 83, 83)
                        .addComponent(btnConfirm))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addGap(11, 11, 11)
                        .addComponent(lblReason)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(cmbReason, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(lblDateValue))
                .addContainerGap(18, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(12, 12, 12)
                .addComponent(lblTitle)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblProductID)
                    .addComponent(txtId, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblQuantity)
                    .addComponent(txtQuantity, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addComponent(lblDateValue)
                .addGap(32, 32, 32)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblReason)
                    .addComponent(cmbReason, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 72, Short.MAX_VALUE)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnReturn)
                    .addComponent(btnConfirm))
                .addGap(93, 93, 93))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnReturnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnReturnActionPerformed
        this.dispose();
        
    }//GEN-LAST:event_btnReturnActionPerformed

    private void txtQuantityActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtQuantityActionPerformed

        
    }//GEN-LAST:event_txtQuantityActionPerformed

    private void btnConfirmActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnConfirmActionPerformed
        onConfirmReturn();
    }//GEN-LAST:event_btnConfirmActionPerformed
    
    private void onConfirmReturn() {
        String id = getProductIdInput();
        String quantityStr = getQuantityInput();
        String reason = getSelectedReason();

        if (!isQuantityValid(quantityStr)) {
            showMessage("Ingrese una número entero positivo.");
            return;
        }

        int quantity = Integer.parseInt(quantityStr);

        ec.edu.espe.finvory.model.Product foundProduct = findProductById(id);
        if (foundProduct == null) {
            showMessage("El producto con ID " + id + " no existe.");
            return;
        }

        if (!confirmAction("¿Confirmar devolución?")) {
            return;
        }

        registerReturn(foundProduct, quantity, reason);
        showMessage("Devolución registrada con éxito.");
        this.dispose();
    
    }

    private String getProductIdInput() {
        return txtId.getText().trim();
    }

    private String getQuantityInput() {
        return txtQuantity.getText().trim();
    }

    private String getSelectedReason() {
        Object selected = cmbReason.getSelectedItem();
        return selected == null ? "" : selected.toString();
    }

    private boolean isQuantityValid(String quantityStr) {
        return ec.edu.espe.finvory.utils.ValidationUtils.isValidQuantity(quantityStr);
    }

    private ec.edu.espe.finvory.model.Product findProductById(String id) {
        if (controller == null || controller.getData() == null || controller.getData().getProducts() == null) {
            return null;
        }

        for (ec.edu.espe.finvory.model.Product p : controller.getData().getProducts()) {
            if (p != null && p.getId() != null && p.getId().equalsIgnoreCase(id)) {
                return p;
            }
        }
        return null;
    }

    private boolean confirmAction(String message) {
        int option = JOptionPane.showConfirmDialog(this, message, "Confirmación", JOptionPane.YES_NO_OPTION);
        return option == JOptionPane.YES_OPTION;
    }

    private void registerReturn(ec.edu.espe.finvory.model.Product product, int quantity, String reason) {
        ec.edu.espe.finvory.model.ReturnedProduct ret =
                new ec.edu.espe.finvory.model.ReturnedProduct(product, quantity, reason);

        controller.getData().addReturn(ret);
        controller.getData().getObsoleteInventory().addStock(product.getId(), quantity);
        controller.saveData();
    }

    private void showMessage(String msg) {
        JOptionPane.showMessageDialog(this, msg);
    }


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnConfirm;
    private javax.swing.JButton btnReturn;
    private javax.swing.JComboBox<String> cmbReason;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JLabel lblDateValue;
    private javax.swing.JLabel lblProductID;
    private javax.swing.JLabel lblQuantity;
    private javax.swing.JLabel lblReason;
    private javax.swing.JLabel lblTitle;
    private javax.swing.JTextField txtId;
    private javax.swing.JTextField txtQuantity;
    // End of variables declaration//GEN-END:variables
}
